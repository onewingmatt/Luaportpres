<!DOCTYPE html>
<html>
<head>
    <title>President Card Game</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 2rem; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        h2 { color: #555; border-bottom: 2px solid #4CAF50; padding-bottom: 0.5rem; }
        .section { margin: 2rem 0; padding: 1.5rem; border: 1px solid #e0e0e0; border-radius: 4px; }
        label { display: block; margin: 0.75rem 0; color: #555; }
        input[type="text"], select { width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        input[type="checkbox"] { margin-right: 0.5rem; }
        button { padding: 0.75rem 1.5rem; margin: 0.5rem 0.5rem 0.5rem 0; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .info { background: #e8f5e9; border-left: 4px solid #4CAF50; padding: 1rem; margin: 1rem 0; border-radius: 4px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; padding: 1rem; margin: 1rem 0; border-radius: 4px; color: #c62828; }
        .game-url { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 1rem; margin: 1rem 0; border-radius: 4px; }
        .game-url-label { font-weight: 600; color: #1565c0; margin-bottom: 0.5rem; }
        .game-url-text { font-family: monospace; background: white; padding: 0.5rem; border-radius: 4px; word-break: break-all; }

        #setupSection { }
        #joinSection { display: none; }
        #gameSection { display: none; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0; }

        #playersStatus { margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 4px; }
        .players-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .player-badge { padding: 0.75rem 1rem; background: white; border: 2px solid #ddd; border-radius: 4px; text-align: center; min-width: 100px; transition: all 0.2s; }
        .player-badge.active { background: #4CAF50; color: white; border-color: #4CAF50; font-weight: 600; box-shadow: 0 0 8px rgba(76, 175, 80, 0.5); }
        .player-badge.out { background: #e0e0e0; color: #999; opacity: 0.6; }
        .player-badge.cpu::after { content: " ðŸ¤–"; }
        .player-name { font-weight: 500; }
        .card-count { font-size: 0.9rem; color: #666; }
        .player-badge.active .card-count { color: white; }

        #hand { margin-top: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 4px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .card { padding: 0.75rem 1rem; margin: 0; background: white; border: 2px solid #333; border-radius: 4px; font-weight: bold; cursor: pointer; user-select: none; transition: all 0.2s; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .card.red { color: #d32f2f; }
        .card.black { color: #000; }
        .card.selected { background: #4CAF50; color: white; }
        #tableSection { margin-top: 2rem; padding: 1rem; background: #e8f5e9; border-radius: 4px; min-height: 100px; }
        #table { display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 60px; }
        .meld-label { font-weight: 600; color: #2e7d32; margin-bottom: 0.5rem; }
        #playLog { margin-top: 1rem; max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 0.5rem; border-radius: 4px; font-size: 0.85rem; font-family: monospace; }
        .log-entry { padding: 0.25rem 0; border-bottom: 1px solid #eee; }
        .log-entry.cpu { color: #999; }
        .log-timestamp { color: #2196f3; font-weight: 600; }
        .log-cards { color: #d32f2f; }

        #gameOverSection { display: none; text-align: center; }
        #gameOverSection h2 { color: #f44336; border-color: #f44336; }
        #roleSection { margin: 2rem 0; }
        .roles-list { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0; }
        .role-item { padding: 1rem; background: #f5f5f5; border-radius: 4px; border-left: 4px solid #4CAF50; }
        .role-name { font-weight: 600; color: #2e7d32; }
        .player-name-role { font-size: 1.2rem; margin-top: 0.5rem; }

        #swapSection { display: none; }
        .swap-instruction { background: #fff3cd; border-left: 4px solid #ff9800; padding: 1rem; margin: 1rem 0; border-radius: 4px; color: #856404; }
        #swapHand { margin-top: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 4px; display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 80px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>â™  President Card Game â™ </h1>

        <div class="section" id="setupSection">
            <h2>Create New Game</h2>
            <label>Your Name:
                <input type="text" id="playerName" placeholder="Enter your name">
            </label>

            <label>Number of CPU Players:
                <select id="numCpus">
                    <option value="1">1 CPU</option>
                    <option value="2" selected>2 CPUs</option>
                    <option value="3">3 CPUs</option>
                </select>
            </label>

            <div style="background: #f5f5f5; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                <h3 style="margin-top: 0;">Game Options</h3>
                <div class="options-grid">
                    <label style="margin: 0;">
                        <input type="checkbox" id="opt-2s"> 2s are Wild
                    </label>
                    <label style="margin: 0;">
                        <input type="checkbox" id="opt-black3"> Black 3s are Wild
                    </label>
                    <label style="margin: 0;">
                        <input type="checkbox" id="opt-jd"> Jack of Diamonds is Wild
                    </label>
                </div>
            </div>

            <button id="createBtn">Create Game</button>
        </div>

        <div class="section" id="joinSection">
            <h2>Join Game</h2>
            <label>Your Name:
                <input type="text" id="joinPlayerName" placeholder="Enter your name">
            </label>
            <button id="joinBtn">Join Game</button>
            <button id="backBtn">Back to Create</button>
        </div>

        <div class="section" id="gameSection" style="display: none;">
            <div id="gameUrlSection">
                <div id="gameUrl" class="game-url" style="display: none;">
                    <div class="game-url-label">Share this link to invite others:</div>
                    <div class="game-url-text" id="gameUrlText"></div>
                </div>
                <button id="startBtn">Start Game (Deal Cards)</button>
                <button id="leaveBtn">Leave Game</button>
            </div>

            <div id="dealingSection" style="display:none; margin-top: 1rem;">
                <h3>Dealing cards...</h3>
            </div>

            <div id="playingSection" style="display:none; margin-top: 1rem;">
                <div id="playersStatus">
                    <h3>Players</h3>
                    <div class="players-row" id="playersList"></div>
                </div>

                <h3>Your Hand - <span id="cardCount">0</span> cards</h3>
                <div id="hand"></div>

                <div style="margin-top: 1rem;">
                    <button id="playBtn">Play Selected Cards</button>
                    <button id="clearBtn">Clear Selection</button>
                    <button id="passBtn" disabled>Pass</button>
                </div>

                <div id="tableSection">
                    <h3>Table Meld</h3>
                    <div class="meld-label" id="meldType"></div>
                    <div id="table"></div>
                </div>

                <div id="playLog"></div>
            </div>

            <div id="gameOverSection">
                <h2>Game Over!</h2>
                <div id="roleSection">
                    <h3>Final Roles</h3>
                    <div id="rolesList" class="roles-list"></div>
                </div>
                <button id="swapStartBtn">Proceed to Card Swap</button>
            </div>

            <div id="swapSection">
                <h2>Card Swap</h2>
                <div id="swapRole" style="font-weight: 600; font-size: 1.2rem; margin-bottom: 1rem;"></div>
                <div id="swapInstructions" class="swap-instruction"></div>
                <h3 id="swapHandTitle">Select cards to swap:</h3>
                <div id="swapHand"></div>
                <div style="margin-top: 1rem;">
                    <button id="swapClearBtn">Clear Selection</button>
                    <button id="submitSwapBtn">Submit Swap</button>
                </div>
                <div id="swapStatus" style="margin-top: 1rem; font-size: 0.9rem; color: #666;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        let selectedCards = [];
        let currentHand = [];
        let selectedSwapCards = [];
        let allRoles = {};
        let roleData = {};
        let gameId = '';
        let playerName = '';

        const urlParams = new URLSearchParams(window.location.search);
        const rejoinGameId = urlParams.get('game');

        function isRedSuit(suit) {
            return suit === 'â™¥' || suit === 'â™¦';
        }

        function isCardSelected(card) {
            return selectedCards.some(c => c.rank === card.rank && c.suit === card.suit);
        }

        function isSwapCardSelected(card) {
            return selectedSwapCards.some(c => c.rank === card.rank && c.suit === card.suit);
        }

        function refreshHandDisplay() {
            const handDiv = document.getElementById('hand');
            handDiv.innerHTML = '';
            currentHand.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card ' + (isRedSuit(card.suit) ? 'red' : 'black');
                if (isCardSelected(card)) cardEl.classList.add('selected');
                cardEl.textContent = card.rank + card.suit;
                cardEl.onclick = function(e) {
                    e.stopPropagation();
                    if (isCardSelected(card)) {
                        selectedCards = selectedCards.filter(c => !(c.rank === card.rank && c.suit === card.suit));
                    } else {
                        selectedCards.push(card);
                    }
                    refreshHandDisplay();
                };
                handDiv.appendChild(cardEl);
            });
            document.getElementById('cardCount').textContent = currentHand.length;
            document.getElementById('passBtn').disabled = currentHand.length === 0;
        }

        function refreshSwapHandDisplay() {
            const swapDiv = document.getElementById('swapHand');
            swapDiv.innerHTML = '';
            if (currentHand.length === 0) {
                swapDiv.innerHTML = '<div style="color: #999;">No cards in hand</div>';
                return;
            }
            currentHand.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card ' + (isRedSuit(card.suit) ? 'red' : 'black');
                if (isSwapCardSelected(card)) cardEl.classList.add('selected');
                cardEl.textContent = card.rank + card.suit;
                cardEl.onclick = function(e) {
                    e.stopPropagation();
                    if (isSwapCardSelected(card)) {
                        selectedSwapCards = selectedSwapCards.filter(c => !(c.rank === card.rank && c.suit === card.suit));
                    } else {
                        selectedSwapCards.push(card);
                    }
                    refreshSwapHandDisplay();
                };
                swapDiv.appendChild(cardEl);
            });
        }

        function updatePlayersStatus(playersStatus) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            playersStatus.forEach(player => {
                const badge = document.createElement('div');
                const isOut = player.card_count === 0;
                badge.className = 'player-badge' + (player.is_active ? ' active' : '') + (player.is_cpu ? ' cpu' : '') + (isOut ? ' out' : '');
                badge.innerHTML = `<div class="player-name">${player.name}${isOut ? ' (out)' : ''}</div><div class="card-count">${player.card_count} cards</div>`;
                playersList.appendChild(badge);
            });
        }

        socket.on('connected', function(data) {
            if (rejoinGameId) {
                document.getElementById('setupSection').style.display = 'none';
                document.getElementById('joinSection').style.display = 'block';
            }
        });

        document.getElementById('createBtn').onclick = function() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                alert('Please enter your name');
                return;
            }

            playerName = name;
            localStorage.setItem('playerName', name);
            socket.emit('create', {
                name: name,
                cpus: parseInt(document.getElementById('numCpus').value),
                options: {
                    wild_2s: document.getElementById('opt-2s').checked,
                    wild_black3: document.getElementById('opt-black3').checked,
                    wild_jd: document.getElementById('opt-jd').checked
                }
            });
        };

        document.getElementById('joinBtn').onclick = function() {
            const name = document.getElementById('joinPlayerName').value.trim();
            if (!name) {
                alert('Please enter your name');
                return;
            }

            playerName = name;
            localStorage.setItem('playerName', name);
            socket.emit('join_game', {
                game_id: rejoinGameId,
                player_name: name
            });
        };

        document.getElementById('backBtn').onclick = function() {
            location.reload();
        };

        socket.on('game_created', function(data) {
            gameId = data.game_id;
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';

            const shareUrl = `${window.location.origin}/?game=${data.game_id}`;
            document.getElementById('gameUrlText').textContent = shareUrl;
            document.getElementById('gameUrl').style.display = 'block';

            window.history.pushState({gameId: data.game_id}, '', `/?game=${data.game_id}`);
        });

        socket.on('game_joined', function(data) {
            gameId = data.game_id;
            document.getElementById('joinSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';

            window.history.pushState({gameId: data.game_id}, '', `/?game=${data.game_id}`);

            if (data.game_state === 'playing') {
                document.getElementById('gameUrlSection').style.display = 'none';
                document.getElementById('playingSection').style.display = 'block';
                currentHand = JSON.parse(JSON.stringify(data.hand));
                refreshHandDisplay();
                updatePlayersStatus(data.players_status);
                if (data.table_meld) {
                    document.getElementById('meldType').textContent = data.meld_type;
                    const tableDiv = document.getElementById('table');
                    tableDiv.innerHTML = '';
                    data.table_meld.forEach(card => {
                        const cardEl = document.createElement('div');
                        cardEl.className = 'card ' + (isRedSuit(card.suit) ? 'red' : 'black');
                        cardEl.textContent = card.rank + card.suit;
                        tableDiv.appendChild(cardEl);
                    });
                }
            }
        });

        socket.on('player_joined', function(data) {
            if (data.players_status) {
                updatePlayersStatus(data.players_status);
            }
            addLogEntry(`${data.player_name} joined the game`, false, null);
        });

        document.getElementById('startBtn').onclick = function() {
            socket.emit('start_game');
        };

        socket.on('ready_to_deal', function(data) {
            document.getElementById('dealingSection').style.display = 'block';
            setTimeout(() => {
                socket.emit('deal_cards');
            }, 500);
        });

        socket.on('cards_dealt', function(data) {
            document.getElementById('dealingSection').style.display = 'none';
            document.getElementById('gameUrlSection').style.display = 'none';
            document.getElementById('playingSection').style.display = 'block';
            currentHand = JSON.parse(JSON.stringify(data.hand));
            refreshHandDisplay();
            if (data.players_status) {
                updatePlayersStatus(data.players_status);
            }
            addLogEntry(`Game started! Dealt ${data.hand_size} cards`, false, null);
        });

        document.getElementById('playBtn').onclick = function() {
            if (selectedCards.length === 0) {
                alert('Select at least 1 card');
                return;
            }
            socket.emit('play_meld', {cards: selectedCards});
        };

        document.getElementById('clearBtn').onclick = function() {
            selectedCards = [];
            refreshHandDisplay();
        };

        document.getElementById('passBtn').onclick = function() {
            socket.emit('pass_turn');
        };

        socket.on('meld_played', function(data) {
            if (data.my_hand) {
                currentHand = JSON.parse(JSON.stringify(data.my_hand));
                selectedCards = [];
                refreshHandDisplay();
            }
            if (data.players_status) {
                updatePlayersStatus(data.players_status);
            }
            const tableDiv = document.getElementById('table');
            tableDiv.innerHTML = '';
            if (data.meld_type) {
                document.getElementById('meldType').textContent = data.meld_type;
            }
            data.meld.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card ' + (isRedSuit(card.suit) ? 'red' : 'black');
                cardEl.textContent = card.rank + card.suit;
                tableDiv.appendChild(cardEl);
            });
            addLogEntry(`${data.player} played ${data.meld_type}`, data.player.includes('CPU'), data.cards_str, data.timestamp);
        });

        socket.on('player_passed', function(data) {
            if (data.players_status) {
                updatePlayersStatus(data.players_status);
            }
            addLogEntry(`${data.player} passed`, data.player.includes('CPU'), null, data.timestamp);
        });

        socket.on('table_cleared', function(data) {
            document.getElementById('table').innerHTML = '';
            document.getElementById('meldType').textContent = '';
            if (data.players_status) {
                updatePlayersStatus(data.players_status);
            }
        });

        socket.on('game_started', function(data) {
            if (data.players_status) {
                updatePlayersStatus(data.players_status);
            }
        });

        socket.on('game_ended', function(data) {
            document.getElementById('playingSection').style.display = 'none';
            document.getElementById('gameOverSection').style.display = 'block';

            allRoles = data.roles;
            roleData = data.role_data || {};

            const rolesList = document.getElementById('rolesList');
            rolesList.innerHTML = '';
            Object.entries(data.roles).forEach(([name, role]) => {
                const item = document.createElement('div');
                item.className = 'role-item';
                item.innerHTML = `<div class="role-name">${role}</div><div class="player-name-role">${name}</div>`;
                rolesList.appendChild(item);
            });
        });

        socket.on('cpu_swaps_submitted', function(data) {
            document.getElementById('swapStatus').textContent = `CPUs auto-swapped (${data.total_submitted}/${data.total_needed} ready)`;
        });

        document.getElementById('swapStartBtn').onclick = function() {
            document.getElementById('gameOverSection').style.display = 'none';
            document.getElementById('swapSection').style.display = 'block';

            const instructions = {
                'President': 'Select your 2 WORST cards to give to the Asshole',
                'Vice President': 'Select your 1 WORST card to give to the Vice Asshole',
                'Vice Asshole': 'Select your 1 BEST card to give to the Vice President',
                'Asshole': 'Select your 2 BEST cards to give to the President',
                'Citizen': 'You do not participate in the card swap'
            };

            let myRoleVal = '';
            for (let name in roleData) {
                if (name === playerName) {
                    myRoleVal = roleData[name].role;
                    currentHand = JSON.parse(JSON.stringify(roleData[name].hand));
                    break;
                }
            }

            if (!myRoleVal) {
                for (let name in roleData) {
                    myRoleVal = roleData[name].role;
                    currentHand = JSON.parse(JSON.stringify(roleData[name].hand));
                    break;
                }
            }

            document.getElementById('swapRole').textContent = `Your Role: ${myRoleVal}`;
            document.getElementById('swapInstructions').textContent = instructions[myRoleVal] || '';

            refreshSwapHandDisplay();

            if (myRoleVal === 'Citizen') {
                document.getElementById('swapHand').style.display = 'none';
                document.getElementById('swapClearBtn').style.display = 'none';
                document.getElementById('swapHandTitle').style.display = 'none';
            }
        };

        document.getElementById('swapClearBtn').onclick = function() {
            selectedSwapCards = [];
            refreshSwapHandDisplay();
        };

        document.getElementById('submitSwapBtn').onclick = function() {
            socket.emit('submit_swap', {cards: selectedSwapCards});
            document.getElementById('submitSwapBtn').disabled = true;
        };

        socket.on('swap_submitted', function(data) {
            document.getElementById('swapStatus').textContent = `${data.player} completed swap (${data.player_count}/${data.total_needed} ready)`;
        });

        socket.on('swaps_complete', function(data) {
            document.getElementById('swapSection').style.display = 'none';
            alert('Swaps complete! Dealing new round...');
        });

        socket.on('new_round_started', function(data) {
            document.getElementById('playingSection').style.display = 'block';
            document.getElementById('gameUrlSection').style.display = 'none';
            if (data.players_status) {
                updatePlayersStatus(data.players_status);
            }
            document.getElementById('hand').innerHTML = '';
            addLogEntry('New round started!', false, null);
        });

        function addLogEntry(text, isCpu, cards, timestamp) {
            const logDiv = document.getElementById('playLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry' + (isCpu ? ' cpu' : '');

            const time = timestamp || new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="log-timestamp">[${time}]</span> ${text}` + (cards ? ` <span class="log-cards">${cards}</span>` : '');

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        document.getElementById('leaveBtn').onclick = function() {
            if (confirm('Leave game?')) {
                location.reload();
            }
        };

        socket.on('error', function(data) {
            alert('Error: ' + data.message);
        });
    </script>
</body>
</html>
